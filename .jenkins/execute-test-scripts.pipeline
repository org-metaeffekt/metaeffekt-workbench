#!/usr/bin/env groovy
pipeline {
    agent {
        // bound to astronaut as various pre-conditions are required:
        // - docker required
        label 'metaeffekt-astronaut'
    }

    environment {
        FTP_HOST = 'web39.alfahosting-server.de'
        FTP_PASS = credentials('ftp-credential')
        FTP_USER = 'h201174_automation'
    }

    stages {

        stage('Cleanup') {
            steps {
                script {
                    // clear the full workspace to start from scratch (except vulnerability mirror data and other indexes)
                    cleanWs()

                    // additionally clean the vulnerability mirror if update should be forced
                    // sh 'rm -rf ../.vulnerability-mirror_gen5'
                }
            }
        }

        stage('Checkout metaeffekt-workbench') {
            steps {
                script {
                    // after clearWs we have to re-checkout the workbench (is there a better way to do this?)
                    withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        git url: 'https://github.com/org-metaeffekt/metaeffekt-workbench.git', branch: 'main', credentialsId: 'JenkinsGithubAccess'
                    }
                }
            }
        }

        stage('Checkout metaeffekt-kontinuum') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-kontinuum'
                    dir ('.metaeffekt-kontinuum') {
                        withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            git url: 'https://github.com/org-metaeffekt/metaeffekt-kontinuum.git', branch: 'main', credentialsId: 'JenkinsGithubAccess'
                        }
                    }
                }
            }
        }

        stage('Checkout metaeffekt-core') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-core'
                    dir ('.metaeffekt-core') {
                        withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            git url: 'https://github.com/org-metaeffekt/metaeffekt-core.git', branch: 'master', credentialsId: 'JenkinsGithubAccess'
                        }
                    }
                }
            }
        }
        stage('Build metaeffekt-core (skipping tests and javadoc)') {
            steps {
                dir ('.metaeffekt-core') {
                    withMaven(jdk: 'ZULU8_mac_mini', maven: 'maven-3.9.6') {
                        sh 'mvn -B clean install -DskipTests -Dmaven.javadoc.skip=true'
                    }
                }
            }
        }

        stage('Checkout metaeffekt-artifact-analysis') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-artifact-analysis'
                    dir ('.metaeffekt-artifact-analysis') {
                        withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            git url: 'https://github.com/org-metaeffekt/metaeffekt-artifact-analysis.git', branch: 'main', credentialsId: 'JenkinsGithubAccess'
                        }
                    }
                }
            }
        }
        stage('Build metaeffekt-artifact-analysis (skipping tests)') {
            steps {
                dir ('.metaeffekt-artifact-analysis') {
                    withMaven(jdk: 'ZULU8_mac_mini', maven: 'maven-3.9.6') {
                        sh 'mvn -B clean install -DskipTests  -Dmaven.javadoc.skip=true'
                    }
                }
            }
        }

        stage('Configure metaeffekt-workbench') {
            steps {
                sh 'echo "EXTERNAL_KONTINUUM_DIR=\"$(pwd)/.metaeffekt-kontinuum\"" > external.rc'

                // this is effectively workspace/.vulnerability-mirror_gen5; so next to the jobs workspace; reconsider as shared
                sh 'echo "EXTERNAL_VULNERABILITY_MIRROR_DIR=\"$(dirname $(pwd))/.vulnerability-mirror_gen5\"" >> external.rc'

                // specify mirror source
                sh 'echo "EXTERNAL_VULNERABILITY_MIRROR_URL=\"http://ae-scanner/mirror/index/ae-mirror-index_gen5.tar.gz\"" >> external.rc'
            }
        }

        stage('Checkout metaeffekt-vulnerability-correlation') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-vulnerability-correlation'
                    dir ('.metaeffekt-vulnerability-correlation') {
                        git url: "http://ae-server:7990/scm/ae/metaeffekt-vulnerability-correlation.git", branch: 'master', credentialsId: 'bitbucket-credentials'
                    }
                    sh 'cp -rf .metaeffekt-vulnerability-correlation/correlation correlations/shared/common'
                }
            }
        }

        stage('Run workspace-001 tests - mongodb_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_mongodb-pipeline_en.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_mongodb-pipeline_en.sh'
                    }

                    // publish inventory (internal)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/mongodb-8.2.2/06_advised/mongodb-8.2.2/mongodb-advised-inventory.xlsx" http://ae-scanner/upload/inventory-index/mongodb-3.1.1/mongodb-advised-inventory-$AE_TIMESTAMP.xlsx'

                    // publish dashboard
                    sh 'curl -T "tests/resources/workspace-001/mongodb-8.2.2/06_advised/mongodb-8.2.2/dashboards/mongodb-8.2.2-dashboard.html" "ftp://$FTP_HOST/html/metaeffekt/dashboards/mongodb-8.2.2-dashboard.html" --user $FTP_USER:$FTP_PASS'
                }
            }
        }

        stage('Run workspace-001 tests - openssl_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_openssl-pipeline_en.sh.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_openssl-pipeline_en.sh'
                    }

                    // publish inventory (internal)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/openssl-3.3.1/06_advised/openssl-3.3.1/openssl-advised-inventory.xlsx" http://ae-scanner/upload/inventory-index/openssl-3.1.1/openssl-advised-inventory-$AE_TIMESTAMP.xlsx'

                    // publish dashboard
                    sh 'curl -T "tests/resources/workspace-001/openssl-3.3.1/06_advised/openssl-3.3.1/dashboards/openssl-3.3.1-dashboard.html" "ftp://$FTP_HOST/html/metaeffekt/dashboards/openssl-3.3.1-dashboard.html" --user $FTP_USER:$FTP_PASS'
                }
            }
        }

        stage('Run workspace-001 tests - windows11_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_windows11-pipeline_en.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_windows11-pipeline_en.sh'
                    }

                    // publish inventory (internal) (patched and unpatched)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/windows11/06_advised/windows11/windows11-advised-inventory_unpatched.xlsx" http://ae-scanner/upload/inventory-index/windows-11_unpatched/windows11-advised-inventory_unpatched-$AE_TIMESTAMP.xlsx'
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/windows11/06_advised/windows11/windows11-advised-inventory_patched.xlsx" http://ae-scanner/upload/inventory-index/windows-11_patched/windows11-advised-inventory_patched-$AE_TIMESTAMP.xlsx'

                    // publish dashboard
                    sh 'curl -T "tests/resources/workspace-001/windows11/06_advised/windows11/dashboards/windows11-dashboard_patched.html" "ftp://$FTP_HOST/html/metaeffekt/dashboards/windows11-dashboard_patched.html" --user $FTP_USER:$FTP_PASS'
                    sh 'curl -T "tests/resources/workspace-001/windows11/06_advised/windows11/dashboards/windows11-dashboard_unpatched.html" "ftp://$FTP_HOST/html/metaeffekt/dashboards/windows11-dashboard_unpatched.html" --user $FTP_USER:$FTP_PASS'
                }
            }
        }

        stage('Run workspace-001 tests - sample-product_de') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_sample-product-pipeline_de.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_sample-product-pipeline_de.sh'
                    }

                    // publish inventory (internal)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/sample-product-1.0.0/06_advised/sample-asset-1.0.0/sample-product-advised-inventory.xlsx" http://ae-scanner/upload/inventory-index/sample-product-1.0.0/sample-product-advised-inventory-$AE_TIMESTAMP.xlsx'
                }
            }
        }

        stage('Run workspace-001 tests - sample-product_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_sample-product-pipeline_en.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_sample-product-pipeline_en.sh'
                    }
                }
            }
        }


        stage('Run workspace-001 tests - react_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_react-pipeline_en.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_react-pipeline_en.sh'
                    }

                    // publish inventory (internal)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/react-19.2.0/06_advised/react-19.2.0/react-advised-inventory.xlsx" http://ae-scanner/upload/inventory-index/react-19.2.0/react-advised-inventory-$AE_TIMESTAMP.xlsx'

                    // publish dashboard
                    sh 'curl -T "tests/resources/workspace-001/react-19.2.0/06_advised/react-19.2.0/dashboards/react-19.2.0-dashboard.html" "ftp://$FTP_HOST/html/metaeffekt/dashboards/react-19.2.0-dashboard.html" --user $FTP_USER:$FTP_PASS'
                }
            }
        }

        stage('Run workspace-001 tests - keycloak_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_react-pipeline_en.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_keycloak-pipeline_en.sh'
                    }

                    // publish inventory (internal)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/keycloak-25.0.4/06_advised/keycloak-25.0.4/keycloak-advised-inventory.xlsx" http://ae-scanner/upload/inventory-index/keycloak-25.0.4/keycloak-advised-inventory-$AE_TIMESTAMP.xlsx'
                }
            }
        }

        stage('Run workspace-001 tests - cisco-catalyst-sd-wan-manager_en') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE', message: '001_cisco-catalyst-sd-wan-manager-pipeline_en.sh failed.') {
                    // run pipeline
                    withMaven(maven: 'maven-3.9.6') {
                        sh './tests/scripts/pipelines/001_cisco-catalyst-sd-wan-manager-pipeline_en.sh'
                    }

                    // publish inventory (internal)
                    sh 'export AE_TIMESTAMP=`date +"%Y-%m-%d@%Hh%Mm"` && curl --create-dirs -T "tests/resources/workspace-001/cisco-catalyst-sd-wan-manager-20.12.5.2/06_advised/cisco-catalyst-sd-wan-manager-20.12.5.2/cisco-catalyst-sd-wan-manager-advised-inventory.xlsx" http://ae-scanner/upload/inventory-index/cisco-catalyst-sd-wan-manager-20.12.5.2/cisco-catalyst-sd-wan-manager-advised-inventory-$AE_TIMESTAMP.xlsx'
                }
            }
        }

    }
}
